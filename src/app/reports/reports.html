<!-- Top Navbar as a Component -->
<app-navbar [role]="role" [isLoggedIn]="true" (logoutEvent)="logout()"></app-navbar>

<!-- Main Layout -->
<div class="d-flex" style="min-height: 100vh; background-color: #f8f9fa;">
  <!-- Sidebar -->
  <aside class="bg-white border-end p-4 shadow-sm" style="width: 250px;">
    <h6 class="fw-bold mb-4 text-primary">üìÇ Navigation</h6>
    <ul class="nav flex-column gap-2">
      <li class="nav-item">
        <a class="nav-link text-dark fw-semibold" [routerLink]="'/dashboard'" routerLinkActive="active">üè† Dashboard</a>
      </li>
      <li class="nav-item">
        <a class="nav-link text-dark fw-semibold" [routerLink]="'/reports'" routerLinkActive="active">üìä Reports</a>
      </li>
      <li class="nav-item">
        <a *ngIf="role === 'SA'" class="nav-link text-dark fw-semibold" routerLink="/feedback" routerLinkActive="active">üìù Feedback</a>
      </li>
    </ul>
  </aside>
  <!-- Content Area -->
  <main class="flex-fill p-4">
    <h5 class="fw-bold text-primary mb-4">üìà Report</h5>
    <app-report-count></app-report-count>
<button mat-raised-button color="primary" (click)="openRequestIncidentModal()">
  Open Request Incident
</button>
<button mat-raised-button color="primary" (click)="openRequestModal(role)">
  View Requests
</button>

    <br>
    <!-- Data Table -->
    <div class="card shadow-sm border-0 rounded-3">
      <div class="card-body">
        <div class="table-responsive">
          <table class="table align-middle table-hover">
            <thead class="table-light">
              <tr class="text-center text-uppercase small">
                <th>#</th>
                <th>Accident Type</th>
                <th>Status</th>
                <th>Timestamp</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of firebaseData" [attr.id]="'report-row-' + item.id" class="text-center">
                <!-- Hidden div to capture as PDF -->
                <td colspan="5" style="display: none;">
                  <div [attr.id]="'report-content-' + item.id" style="padding: 20px; background: white; width: 100%;">
                    <h3>Accident Report</h3>
                    <p><strong>Accident Type:</strong> {{ item.accident_type || 'N/A' }}</p>
                    <p><strong>Status:</strong> {{ item.status }}</p>
                    <p><strong>Timestamp:</strong> {{ item.timestamp | date: 'medium' }}</p>
                    <p *ngIf="item.googleMapLink"><strong>Location:</strong> <a [href]="item.googleMapLink" target="_blank">{{ item.googleMapLink }}</a></p>
                  </div>
                </td>

                <!-- Visible Table Row -->
                <td>{{ firebaseData.indexOf(item) + 1 }}</td>
                <td>{{ item.accident_type || 'N/A' }}</td>
                <td>
                  <span class="badge bg-success" *ngIf="item.status === 'Rescued'">{{ item.status }}</span>
                  <span class="badge bg-danger" *ngIf="item.status === 'Invalid'">{{ item.status }}</span>
                  <span class="badge bg-secondary" *ngIf="item.status !== 'Rescued' && item.status !== 'Invalid'">
                    {{ item.status }}
                  </span>
                </td>
                <td>{{ item.timestamp | date: 'medium' }}</td>
                <td>
                  <div class="d-flex justify-content-center gap-2 flex-wrap">

                    <!-- Location Icon -->
                    <ng-container *ngIf="item.googleMapLink">
                      <a [href]="item.googleMapLink" target="_blank" matTooltip="View Location">
                        <button mat-mini-fab color="primary">
                          <mat-icon>location_on</mat-icon>
                        </button>
                      </a>
                    </ng-container>

                    <!-- Media Dialog Button -->
                    <ng-container *ngIf="item.media_url; else noMedia">
                      <button mat-mini-fab color="accent" (click)="openImageDialog(item.media_url)" matTooltip="View Image">
                        <mat-icon>image</mat-icon>
                      </button>
                    </ng-container>
                    <ng-template #noMedia>
                      <button mat-mini-fab disabled color="warn" matTooltip="No Media Available">
                        <mat-icon>image_not_supported</mat-icon>
                      </button>
                    </ng-template>

                    <!-- Responding -->
                    <button mat-mini-fab style="background-color: #ff9800; color: white;" (click)="markAsResponding(item.id)" matTooltip="Mark as Responding">
                      <mat-icon>notification_important</mat-icon>
                    </button>

                    <!-- Rescued -->
                    <button mat-mini-fab style="background-color: #4caf50; color: white;" (click)="markAsRescued(item.id)" matTooltip="Mark as Rescued">
                      <mat-icon>check_circle</mat-icon>
                    </button>

                    <!-- Invalid -->
                    <button mat-mini-fab style="background-color: #f44336; color: white;" (click)="markAsInvalid(item.id)" matTooltip="Mark as Invalid">
                      <mat-icon>cancel</mat-icon>
                    </button>

                    <!-- Print to PDF -->
                    <button mat-mini-fab color="primary" (click)="triggerPrintToPDF(item)" matTooltip="Print Report">
                      <mat-icon>picture_as_pdf</mat-icon>
                    </button>

                    <!-- Accept buttons (only if this.role matches requested department) -->
                    <button *ngIf="item.requestedTo === 'MDRRMO' && role === 'MDRRMO'"
                            mat-mini-fab color="accent"
                            (click)="acceptPdfRequestIncidentFromMDRRMO(item)"
                            matTooltip="Accept Incident Report From MDRRMO">
                      <mat-icon>check_circle</mat-icon>
                    </button>

                    <button *ngIf="item.requestedTo === 'BFP' && role === 'BFP'"
                            mat-mini-fab color="accent"
                            (click)="acceptPdfRequestIncidentFromBFP(item)"
                            matTooltip="Accept Incident Report From BFP">
                      <mat-icon>check_circle</mat-icon>
                    </button>

                    <button *ngIf="item.requestedTo === 'PNP' && role === 'PNP'"
                            mat-mini-fab color="accent"
                            (click)="acceptPdfRequestIncidentFromPNP(item)"
                            matTooltip="Accept Incident Report From PNP">
                      <mat-icon>check_circle</mat-icon>
                    </button>

                  </div>
                </td>
              </tr>
              <tr *ngIf="firebaseData.length === 0">
                <td colspan="5" class="text-center text-muted">No data available.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>
</div>
